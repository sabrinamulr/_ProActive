@page "/login-redirect"
@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja
@using Microsoft.EntityFrameworkCore
@inject AppDbContext _context
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<p>Bitte warten…</p>

@code {
    protected override async Task OnInitializedAsync()
    {
        // Benutzer holen
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity.IsAuthenticated)
        {
            Nav.NavigateTo("/auth/login");
            return;
        }

        // Benutzer-ID aus Claims holen
        var userIdClaim = user.Claims.FirstOrDefault(c => c.Type.Contains("nameidentifier"));
        if (userIdClaim == null)
        {
            Nav.NavigateTo("/");
            return;
        }

        int userId = int.Parse(userIdClaim.Value);

        // Prüfen, ob ein abgeschlossenes Projekt ohne Feedback existiert
        var offenesProjekt = await _context.Projekte
            .Where(p => p.BenutzerId == userId &&
                        p.Status == Projektstatus.Abgeschlossen &&
                        !p.Antworten.Any())
            .FirstOrDefaultAsync();

        if (offenesProjekt != null)
        {
            Nav.NavigateTo($"/feedback-info/{offenesProjekt.Id}");
            return;
        }

        // Wenn kein Feedback fällig → Home
        Nav.NavigateTo("/");
    }
}