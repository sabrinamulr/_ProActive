@page "/login-redirect"
@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject AppDbContext _context
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<p>Bitte warten…</p>

@code {
    protected override async Task OnInitializedAsync()
    {
        // Benutzer holen
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Nav.NavigateTo("/auth/login");
            return;
        }

        // Benutzer-ID aus Claims holen
        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out var userId))
        {
            Nav.NavigateTo("/");
            return;
        }

        // Prüfen, ob ein abgeschlossenes Projekt ohne Feedback existiert
        var offenesProjekt = await _context.Projekte
            .Where(p => p.BenutzerId == userId &&
                        p.Status == Projektstatus.Abgeschlossen &&
                        !p.Antworten.Any())
            .FirstOrDefaultAsync();

        if (offenesProjekt != null)
        {
            Nav.NavigateTo($"/feedback-info/{offenesProjekt.Id}");
            return;
        }

        // Wenn kein Feedback fällig → Home
        Nav.NavigateTo("/");
    }
}
