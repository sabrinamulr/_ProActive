@page "/auswertung"

@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja
@using Microsoft.EntityFrameworkCore
@using Radzen.Blazor

@inject AppDbContext _context
@rendermode InteractiveServer


<div class="container mt-4">

    <h2 class="mb-4">Auswertung</h2>

    @if (isLoading)
    {
        <div class="alert alert-info">Lade Daten…</div>
    }
    else
    {
        

        <!-- ⭐ GLOBALER PROJEKTVERGLEICH -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Projektvergleich – Durchschnitt pro Projekt (alle Projekte)</strong>
            </div>

            <div class="card-body">
                @if (projektDurchschnitte.Count == 0)
                {
                    <p>Keine Antworten für die Projekte vorhanden.</p>
                }
                else
                {
                    <RadzenChart Style="height:300px; width:100%;">
<RadzenAreaSeries Data="@projektDurchschnitte"
                  CategoryProperty="ProjektName"
                  ValueProperty="Durchschnitt"
                  Title="Durchschnittsbewertung">
    <TooltipTemplate Context="p">
        <div style="padding:4px; background:#74181E; color:white; border-radius:4px;">
            <strong>@p.ProjektName</strong><br />
            Durchschnitt: @p.Durchschnitt.ToString("0.00")
        </div>
    </TooltipTemplate>
</RadzenAreaSeries>                    
</RadzenChart>

                    <!-- Debug optional -->
                    <h5 class="mt-4">Debug: ProjektDurchschnitte</h5>
                    <table class="table table-sm table-bordered" style="max-width:500px;">
                        <thead>
                            <tr>
                                <th>ProjektId</th>
                                <th>ProjektName</th>
                                <th>Durchschnitt</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in projektDurchschnitte)
                            {
                                <tr>
                                    <td>@p.ProjektId</td>
                                    <td>@p.ProjektName</td>
                                    <td>@p.Durchschnitt</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>

        <!-- ⭐ DETAILANSICHT -->
        @if (selectedProjectId != null && aktuellesProjekt != null)
        {
            <div class="card mb-4">
                <div class="card-header">
                    <strong>Detailauswertung – @aktuellesProjekt.Projektbeschreibung</strong>
                </div>

                <div class="card-body">

                    <p><strong>Status:</strong> @aktuellesProjekt.Status</p>

                    @if (antwortenProjekt.Count > 0)
                    {
                        <!-- ⭐ STERNVERTEILUNG -->
                        <h4 class="mt-4">Sternverteilung (Projekt)</h4>
                        <RadzenChart Style="height:300px; width:100%;">
<RadzenColumnSeries Data="@ratingItemsProjekt"
                    CategoryProperty="Category"
                    ValueProperty="Value"
                    Title="Bewertungen">
    <TooltipTemplate Context="item">
        <div style="padding:4px; background:#74181E; color:white; border-radius:4px;">
            @item.Category<br />
            @item.Value Antworten
        </div>
    </TooltipTemplate>
</RadzenColumnSeries>
                        </RadzenChart>

                        <!-- ⭐ KATEGORIE-AUSWERTUNG -->
                        <h4 class="mt-4">Durchschnitt pro Kategorie</h4>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Kategorie</th>
                                    <th>Durchschnitt</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var k in kategorieAuswertungenProjekt)
                                {
                                    <tr>
                                        <td>@k.KategorieName</td>
                                        <td>@k.Durchschnitt.ToString("0.0")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        <!-- ⭐ ALLE ANTWORTEN -->
                        <h4 class="mt-4">Alle Antworten</h4>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Frage</th>
                                    <th>Sterne</th>
                                    <th>Datum</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var a in antwortenProjekt)
                                {
                                    <tr>
                                        <td>@a.FrageId</td>
                                        <td>@a.Rating</td>
                                        <td>@(a.Datum == default ? "-" : a.Datum.ToString("dd.MM.yyyy HH:mm"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>Keine Antworten für dieses Projekt vorhanden.</p>
                    }
                </div>
            </div>
        }
        else
        {
            <p class="mt-3">Bitte ein Projekt auswählen, um Details zu sehen.</p>
        }
        <!-- ⭐ PROJEKT-AUSWAHL -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Projekt auswählen (Detailansicht)</strong>
            </div>
            <div class="card-body">
                <select class="form-select w-auto"
                        @onchange="OnProjectChanged">
                    <option value="">-- Bitte wählen --</option>
                    @foreach (var p in projektListe)
                    {
                        <option value="@p.Id">@p.Projektbeschreibung</option>
                    }
                </select>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;

    // Globale Daten (alle Antworten)
    private List<Antwort> alleAntworten = new();
    private List<Projekt> projektListe = new();

    // Globale Auswertungen
    private List<ProjektDurchschnitt> projektDurchschnitte = new();

    // Auswahl für Detail
    private int? selectedProjectId = null;
    private Projekt? aktuellesProjekt;
    private List<Antwort> antwortenProjekt = new();

    // Sternverteilung pro Projekt
    private List<RatingItem> ratingItemsProjekt = new();

    // Kategorien pro Projekt
    private List<KategorieAuswertung> kategorieAuswertungenProjekt = new();

    // Hilfsklassen
    private class RatingItem
    {
        public string Category { get; set; } = "";
        public int Value { get; set; }
    }

    public class KategorieAuswertung
    {
        public string KategorieName { get; set; } = "";
        public double Durchschnitt { get; set; }
    }

    public class ProjektDurchschnitt
    {
        public int ProjektId { get; set; }
        public string ProjektName { get; set; } = "";
        public double Durchschnitt { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        // Alle Projekte
        projektListe = await _context.Projekte
            .AsNoTracking()
            .OrderBy(p => p.Id)
            .ToListAsync();

        // Alle Antworten inkl. Projekt / Frage / Kategorie
        alleAntworten = await _context.Antworten
            .Include(a => a.Projekt)
            .Include(a => a.Frage)
                .ThenInclude(f => f.Kategorie)
            .AsNoTracking()
            .ToListAsync();

        BerechneProjektDurchschnitte();

        isLoading = false;
    }

    private void BerechneProjektDurchschnitte()
    {
        projektDurchschnitte = alleAntworten
            .Where(a => a.Projekt != null)
            .GroupBy(a => a.ProjektId)
            .Select(g => new ProjektDurchschnitt
            {
                ProjektId = g.Key,
                ProjektName = g.First().Projekt!.Projektbeschreibung,
                Durchschnitt = g.Average(a => a.Rating)
            })
            .OrderBy(p => p.ProjektId)
            .ToList();
    }

    private async Task OnProjectChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
            selectedProjectId = id;
        else
            selectedProjectId = null;

        await LadeProjektDetails();
    }

    private async Task LadeProjektDetails()
    {
        if (selectedProjectId == null)
        {
            aktuellesProjekt = null;
            antwortenProjekt.Clear();
            ratingItemsProjekt.Clear();
            kategorieAuswertungenProjekt.Clear();
            return;
        }

        aktuellesProjekt = await _context.Projekte
            .AsNoTracking()
            .FirstOrDefaultAsync(p => p.Id == selectedProjectId.Value);

        antwortenProjekt = alleAntworten
            .Where(a => a.ProjektId == selectedProjectId.Value)
            .ToList();

        BerechneSternverteilungProjekt();
        BerechneKategorieAuswertungProjekt();
    }

    private void BerechneSternverteilungProjekt()
    {
        var counts = new int[5];

        foreach (var a in antwortenProjekt)
        {
            if (a.Rating >= 1 && a.Rating <= 5)
                counts[a.Rating - 1]++;
        }

        ratingItemsProjekt = new()
        {
            new RatingItem { Category = "1 Stern", Value = counts[0] },
            new RatingItem { Category = "2 Sterne", Value = counts[1] },
            new RatingItem { Category = "3 Sterne", Value = counts[2] },
            new RatingItem { Category = "4 Sterne", Value = counts[3] },
            new RatingItem { Category = "5 Sterne", Value = counts[4] }
        };
    }

    private void BerechneKategorieAuswertungProjekt()
    {
        kategorieAuswertungenProjekt = antwortenProjekt
            .GroupBy(a => a.Frage.KategorieId)
            .Select(g => new KategorieAuswertung
            {
                KategorieName = g.First().Frage.Kategorie.Name,
                Durchschnitt = g.Average(a => a.Rating)
            })
            .OrderBy(k => k.KategorieName)
            .ToList();
    }
}