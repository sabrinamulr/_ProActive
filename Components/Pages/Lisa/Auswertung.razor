@page "/auswertung"

@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja
@using Microsoft.EntityFrameworkCore

@inject AppDbContext _context
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="container mt-4">

    <h2 class="mb-4">Auswertung</h2>

    @if (isLoading)
    {
        <div class="alert alert-info">Lade Daten…</div>
    }
    else
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Projektvergleich – Durchschnitt pro Projekt (alle Projekte)</strong>
                
            </div>
            

            <div class="card-body">
                @if (projektDurchschnitte.Count == 0)
                {
                    <p>Keine Antworten für die Projekte vorhanden.</p>
                }
                else
                {
                    <canvas id="projektVergleichChart" style="height:50px width=50px !important;"></canvas>
                    <p font-size="20"><strong>Antworten Anzahl (aller Projekte):</strong> @alleAntworten.Count</p>
                    <!-- Debug optional -->
                    <h5 class="mt-4"> Durchschnitte der Projekte</h5>
                    <table class="table table-sm table-bordered" style="max-width:500px;">
                        <thead>
                            <tr>
                                <th>ProjektId</th>
                                <th>ProjektName</th>
                                <th>Durchschnitt</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (ProjektDurchschnitt p in projektDurchschnitte)
                            {
                                <tr>
                                    <td>@p.ProjektId</td>
                                    <td>@p.ProjektName</td>
                                    <td>@p.Durchschnitt</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>

        @if (selectedProjectId != null && aktuellesProjekt != null)
        {
            <div class="card mb-4">
                <div class="card-header">
                    <strong>Detailauswertung – @aktuellesProjekt.Projektbeschreibung</strong>
                </div>

                <div class="card-body">

                    <p><strong>Status:</strong> @aktuellesProjekt.Status</p>

                    @if (antwortenProjekt.Count > 0)
                    {
                        <div class="row">
                            <div class="col-lg-6">
                                <h4 class="mt-4">Sternverteilung (Projekt)</h4>
                                <canvas id="sternChart" height="200"></canvas>

                                <h4 class="mt-4">Durchschnitt pro Kategorie</h4>
                                <canvas id="kategorieChart" height="200"></canvas>
                            </div>

                            <div class="col-lg-6">
                                <h4 class="mt-4">Anzahl der Antworten per Kategorie</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Kategorie</th>
                                            <th>Anzahl der Antworten</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (KategorieAuswertung k in kategorieAuswertungenProjekt)
                                        {
                                            <tr>
                                                <td>@k.KategorieName</td>
                                                <td>@k.Anzahl</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                <h4 class="mt-4">Kategorien - Durchschnitt</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Kategorie</th>
                                            <th>Durchschnitt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (KategorieAuswertung k in kategorieAuswertungenProjekt)
                                        {
                                            <tr>
                                                <td>@k.KategorieName</td>
                                                <td>@k.Durchschnitt.ToString("0.0")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

   
                            </div>
                        </div>
                    }
                    else
                    {
                        <p>Keine Antworten für dieses Projekt vorhanden.</p>
                    }
                </div>
            </div>
        }
        else
        {
            <p class="mt-3">Bitte ein Projekt auswählen, um Details zu sehen.</p>
        }

        <div class="card mb-4">
            <div class="card-header">
                <strong>Projekt auswählen (Detailansicht)</strong>
            </div>
            <div class="card-body">
                <select class="form-select w-auto"
                        @onchange="OnProjectChanged">
                    <option value="">-- Bitte wählen --</option>
                    @foreach (Projekt p in projektListe)
                    {
                        <option value="@p.Id">@p.Projektbeschreibung</option>
                    }
                </select>
            </div>
        </div>
    }
</div>

@code {

    private bool isLoading = true; //ob die Seite lädt

    private List<Antwort> alleAntworten = new(); //Alle Antworten aus der Datenbank
    private List<Projekt> projektListe = new(); //alle Projekte aus der DB

    private List<ProjektDurchschnitt> projektDurchschnitte = new(); //Durchschnittsbewertung pro Projekt

    private int? selectedProjectId = null; //speichert id des ausgewählten Projekts, null = noch kein Projekt ausgewählt
    private Projekt? aktuellesProjekt; //das aktuell ausgewählte Projekt als objekt
    private List<Antwort> antwortenProjekt = new(); //alle antworten nur für das ausgewählte projekt

    private List<RatingItem> ratingItemsProjekt = new(); //anzahl der 1-stern, ... bewertungen für das Projekt

    private List<KategorieAuswertung> kategorieAuswertungenProjekt = new(); //durchschnittsbewertungen pro Kategorie

    //hilfsklassen
    private class RatingItem //sterndiagramm
    {
        public string Category { get; set; } = ""; //1 Stern,...
        public int Value { get; set; } //anzahl
    }

    public class KategorieAuswertung //kategorie auswertung
    {
        public string KategorieName { get; set; } = "";
        public double Durchschnitt { get; set; }
        public int Anzahl { get; set; } //antworten diser kat

    }

    public class ProjektDurchschnitt //projektvergleih diagramm
    {
        public int ProjektId { get; set; }
        public string ProjektName { get; set; } = "";
        public double Durchschnitt { get; set; }
    }

    protected override async Task OnInitializedAsync() //Daten werden beim initialen Laden der Seite geholt und berechnet
    {
        isLoading = true; //ladeseite aktiviert

        //holt alle preojekte aus der db
        projektListe = await _context.Projekte
            .AsNoTracking() //schneller, weil keine änderungen gespeichert werden müssen
            .OrderBy(p => p.Id)
            .ToListAsync();

        //alle Antworten inkl. Projekt / Frage / Kategorie
        alleAntworten = await _context.Antworten
            .Include(a => a.Projekt)
            .Include(a => a.Frage)
                .ThenInclude(f => f.Kategorie)
            .AsNoTracking()
            .ToListAsync();

        BerechneProjektDurchschnitte(); //durchschnittsbewertungen pro projekt berechnen

        isLoading = false; //seite ist fertig geladen
    }

    private void BerechneProjektDurchschnitte()
    {
        //liste für Antworten die ein Projekt besitzen
        List<Antwort> gefilterteAntworten = new List<Antwort>();

        // .Where(a => a.Projekt != null) ersetzt:
        //schleife filtert alle antworten bei denen ein Projekt existiert
        foreach (Antwort antwort in alleAntworten)
        {
            if (antwort.Projekt != null)
            {
                gefilterteAntworten.Add(antwort);
            }
        }

        // Dictionary für Gruppierung nach ProjektId
        // ersetzt .GroupBy(a => a.ProjektId)
        Dictionary<int, List<Antwort>> gruppen = new Dictionary<int, List<Antwort>>();

        foreach (Antwort antwort in gefilterteAntworten)
        {
            int key = antwort.ProjektId; //gruppierungsschlüssel = ProjektId

            //wenn Gruppe noch nicht existiert --> neue Liste anlegen
            if (!gruppen.ContainsKey(key))
            {
                gruppen[key] = new List<Antwort>();
            }

            //antwort zur passenden Gruppe hinzufügen
            gruppen[key].Add(antwort);
        }

        //liste für die berechneten Projektdurchschnitte
        List<ProjektDurchschnitt> liste = new List<ProjektDurchschnitt>();

        // ersetzt .Select(g => new ProjektDurchschnitt { ... })
        foreach (var gruppe in gruppen)
        {
            int projektId = gruppe.Key; //schlüssel = ProjektId
            List<Antwort> antworten = gruppe.Value; //alle Antworten zu diesem Projekt

            ProjektDurchschnitt pd = new ProjektDurchschnitt();
            pd.ProjektId = projektId;

            //projektname aus erster Antwort entnehmen
            pd.ProjektName = antworten[0].Projekt!.Projektbeschreibung;

            //durchschnitt berechnen
            double summe = 0;
            foreach (Antwort a in antworten)
            {
                summe =summe + a.Rating;
            }
            pd.Durchschnitt = summe / antworten.Count;

            liste.Add(pd);
        }

        liste.Sort((x, y) => x.ProjektId.CompareTo(y.ProjektId));

        //ergebnis speichern
        projektDurchschnitte = liste;
    }

    private async Task OnProjectChanged(ChangeEventArgs e) //wenn der benutzer ein projekt auswählt wird die id gespeichert
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedProjectId = id;

        }
        else
        {
            selectedProjectId = null;

        }

        await LadeProjektDetails(); //danach werden die details des projekts geladen
    }

    private async Task LadeProjektDetails()
    {
        if (selectedProjectId == null) //wenn kein projekt ausgewählt wird --> alles zurücksetzen
        {
            aktuellesProjekt = null;
            antwortenProjekt.Clear();
            ratingItemsProjekt.Clear();
            kategorieAuswertungenProjekt.Clear();
            return;
        }

        aktuellesProjekt = await _context.Projekte //holt das ausgewählte projekt aus der db
            .AsNoTracking()
            .FirstOrDefaultAsync(p => p.Id == selectedProjectId.Value);

        // ersetzt:
        // .Where(a => a.ProjektId == selectedProjectId.Value).ToList();
        antwortenProjekt = new List<Antwort>();

        foreach (Antwort a in alleAntworten)
        {
            if (a.ProjektId == selectedProjectId.Value)
            {
                antwortenProjekt.Add(a);
            }
        }

        BerechneSternverteilungProjekt();
        BerechneKategorieAuswertungProjekt();
        //sternverteilung und kategorie durchschnitt wird berechnet
    }

    private void BerechneSternverteilungProjekt()
    {
        int[] counts = new int[5]; //array 1-5 sterne

        foreach (Antwort a in antwortenProjekt) //zählt wie oft jde sternzahl vorkommt
        {
            if (a.Rating >= 1 && a.Rating <= 5)
            {
                counts[a.Rating - 1]++;
            }
        }

        ratingItemsProjekt = new() //erstellt die liste für das diagramm
        {
            new RatingItem { Category = "1 Stern", Value = counts[0] },
            new RatingItem { Category = "2 Sterne", Value = counts[1] },
            new RatingItem { Category = "3 Sterne", Value = counts[2] },
            new RatingItem { Category = "4 Sterne", Value = counts[3] },
            new RatingItem { Category = "5 Sterne", Value = counts[4] }
        };
    }

    private void BerechneKategorieAuswertungProjekt()
    {
        // Dictionary für Gruppierung nach KategorieId
        // ersetzt .GroupBy(a => a.Frage.KategorieId)
        Dictionary<int, List<Antwort>> gruppen = new Dictionary<int, List<Antwort>>();

        foreach (Antwort antwort in antwortenProjekt)
        {
            int key = antwort.Frage.KategorieId;

            if (!gruppen.ContainsKey(key))
            {
                gruppen[key] = new List<Antwort>();
            }

            gruppen[key].Add(antwort);
        }

        //liste für Kategorie-Auswertungen
        List<KategorieAuswertung> liste = new List<KategorieAuswertung>();

        // ersetzt .Select(g => new KategorieAuswertung { ... })
        foreach (var gruppe in gruppen)
        {
            int kategorieId = gruppe.Key;
            List<Antwort> antworten = gruppe.Value;

            KategorieAuswertung auswertung = new KategorieAuswertung();

            //name der Kategorie aus erster Antwort
            auswertung.KategorieName = antworten[0].Frage.Kategorie.Name;

            double summe = 0;
            foreach (Antwort a in antworten)
            {
                summe = summe + a.Rating;
            }
            auswertung.Durchschnitt = summe / antworten.Count;

            // Anzahl der Antworten
            auswertung.Anzahl = antworten.Count;

            liste.Add(auswertung);
        }

        liste.Sort((x, y) => x.KategorieName.CompareTo(y.KategorieName));

        kategorieAuswertungenProjekt = liste;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (projektDurchschnitte.Any()) //wenn es projektdaten gibt --> diagramm rendern
        {
            await RenderProjektVergleichChart();
        }

        if (selectedProjectId != null && antwortenProjekt.Any())//wenn ein projekt ausgewählt ist --> stern und kategorie diagramm rendern
        {
            await RenderSternChart();
            await RenderKategorieChart();
        }
    }

    private async Task RenderProjektVergleichChart()
    {
        await JS.InvokeVoidAsync("createChart",
            "projektVergleichChart",
            "line",
            new
            {
                labels = projektDurchschnitte.Select(p => p.ProjektName),
                datasets = new[]
                {
                    new {
                        label = "Durchschnitt",
                        data = projektDurchschnitte.Select(p => p.Durchschnitt),                   
                        borderColor = "#74181E",
                        backgroundColor = "rgba(116,24,30,0.25)",
                        borderWidth = 2,
                        tension = 0.3,
                    }
                }
            },
            new
            {
                responsive = true,

            }
        );
    }

    private async Task RenderSternChart()
    {
        await JS.InvokeVoidAsync("createChart",
            "sternChart",
            "bar",
            new
            {
                labels = ratingItemsProjekt.Select(r => r.Category),
                datasets = new[]
                {
                    new {
                        label = "Bewertungen",
                        data = ratingItemsProjekt.Select(r => r.Value),
                        backgroundColor = "#74181E88",
                        borderColor = "#74181E",
                        borderWidth = 2
                    }
                }
            },
            new
            {
                responsive = true
            }
        );
    }

    private async Task RenderKategorieChart()
    {
        await JS.InvokeVoidAsync("createChart",
            "kategorieChart",
            "bar",
            new
            {
                labels = kategorieAuswertungenProjekt.Select(k => k.KategorieName),
                datasets = new[]
                {
                    new {
                        label = "Durchschnitt",
                        data = kategorieAuswertungenProjekt.Select(k => k.Durchschnitt),
                        backgroundColor = "#74181E88",
                        borderColor = "#74181E",
                        borderWidth = 2
                    }
                }
            },
            new
            {
                indexAxis = "y",
                responsive = true
            }
        );
    }
}