@page "/feedback-auswertung"

@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja
@using Microsoft.EntityFrameworkCore

@inject AppDbContext _context
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="container mt-4">

    <h2 class="mb-4">Auswertung</h2>

    @if (isLoading)
    {
        <div class="alert alert-info">Lade Daten…</div>
    }
    else
    {
        <!-- ⭐ GLOBALER PROJEKTVERGLEICH -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Projektvergleich – Durchschnitt pro Projekt (alle Projekte)</strong>
                
            </div>
            

            <div class="card-body">
                @if (projektDurchschnitte.Count == 0)
                {
                    <p>Keine Antworten für die Projekte vorhanden.</p>
                }
                else
                {
                    <canvas id="projektVergleichChart" style="height:100px !important;"></canvas>
                    <p font-size="20"><strong>Antworten Anzahl (aller Projekte):</strong> @alleAntworten.Count</p>
                    <!-- Debug optional -->
                    <h5 class="mt-4">Debug: ProjektDurchschnitte</h5>
                    <table class="table table-sm table-bordered" style="max-width:500px;">
                        <thead>
                            <tr>
                                <th>ProjektId</th>
                                <th>ProjektName</th>
                                <th>Durchschnitt</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in projektDurchschnitte)
                            {
                                <tr>
                                    <td>@p.ProjektId</td>
                                    <td>@p.ProjektName</td>
                                    <td>@p.Durchschnitt</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>

        <!-- ⭐ DETAILANSICHT -->
        @if (selectedProjectId != null && aktuellesProjekt != null)
        {
            <div class="card mb-4">
                <div class="card-header">
                    <strong>Detailauswertung – @aktuellesProjekt.Projektbeschreibung</strong>
                </div>

                <div class="card-body">

                    <p><strong>Status:</strong> @aktuellesProjekt.Status</p>

                    @if (antwortenProjekt.Count > 0)
                    {
                        <div class="row">
                            <div class="col-lg-6">
                                <!-- ⭐ STERNVERTEILUNG -->
                                <h4 class="mt-4">Sternverteilung (Projekt)</h4>
                                <canvas id="sternChart" height="200"></canvas>

                                <!-- ⭐ KATEGORIE-AUSWERTUNG -->
                                <h4 class="mt-4">Durchschnitt pro Kategorie</h4>
                                <canvas id="kategorieChart" height="200"></canvas>
                            </div>

                            <div class="col-lg-6">
                                  <!-- ⭐ ALLE ANTWORTEN -->
                                <h4 class="mt-4">Anzahl der Antworten per Kategorie</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Kategorie</th>
                                            <th>Anzahl der Antworten</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var k in kategorieAuswertungenProjekt)
                                        {
                                            <tr>
                                                <td>@k.KategorieName</td>
                                                <td>@k.Anzahl</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                <!-- Tabelle Kategorien -->
                                <h4 class="mt-4">Kategorien - Durchschnitt</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Kategorie</th>
                                            <th>Durchschnitt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var k in kategorieAuswertungenProjekt)
                                        {
                                            <tr>
                                                <td>@k.KategorieName</td>
                                                <td>@k.Durchschnitt.ToString("0.0")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

   
                            </div>
                        </div>
                    }
                    else
                    {
                        <p>Keine Antworten für dieses Projekt vorhanden.</p>
                    }
                </div>
            </div>
        }
        else
        {
            <p class="mt-3">Bitte ein Projekt auswählen, um Details zu sehen.</p>
        }

        <!-- ⭐ PROJEKT-AUSWAHL -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Projekt auswählen (Detailansicht)</strong>
            </div>
            <div class="card-body">
                <select class="form-select w-auto"
                        @onchange="OnProjectChanged">
                    <option value="">-- Bitte wählen --</option>
                    @foreach (var p in projektListe)
                    {
                        <option value="@p.Id">@p.Projektbeschreibung</option>
                    }
                </select>
            </div>
        </div>
    }
</div>

@code {
    // 🔹 ALLE DEINE ALTEN FELDER UND KLASSEN

    private bool isLoading = true;

    // Globale Daten (alle Antworten)
    private List<Antwort> alleAntworten = new();
    private List<Projekt> projektListe = new();

    // Globale Auswertungen
    private List<ProjektDurchschnitt> projektDurchschnitte = new();

    // Auswahl für Detail
    private int? selectedProjectId = null;
    private Projekt? aktuellesProjekt;
    private List<Antwort> antwortenProjekt = new();

    // Sternverteilung pro Projekt
    private List<RatingItem> ratingItemsProjekt = new();

    // Kategorien pro Projekt
    private List<KategorieAuswertung> kategorieAuswertungenProjekt = new();

    // Hilfsklassen
    private class RatingItem
    {
        public string Category { get; set; } = "";
        public int Value { get; set; }
    }

    public class KategorieAuswertung
    {
        public string KategorieName { get; set; } = "";
        public double Durchschnitt { get; set; }
        public int Anzahl { get; set; }

    }

    public class ProjektDurchschnitt
    {
        public int ProjektId { get; set; }
        public string ProjektName { get; set; } = "";
        public double Durchschnitt { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        // Alle Projekte
        projektListe = await _context.Projekte
            .AsNoTracking()
            .OrderBy(p => p.Id)
            .ToListAsync();

        // Alle Antworten inkl. Projekt / Frage / Kategorie
        alleAntworten = await _context.Antworten
            .Include(a => a.Projekt)
            .Include(a => a.Frage)
                .ThenInclude(f => f.Kategorie)
            .AsNoTracking()
            .ToListAsync();

        BerechneProjektDurchschnitte();

        isLoading = false;
    }

    private void BerechneProjektDurchschnitte()
    {
        projektDurchschnitte = alleAntworten
            .Where(a => a.Projekt != null)
            .GroupBy(a => a.ProjektId)
            .Select(g => new ProjektDurchschnitt
            {
                ProjektId = g.Key,
                ProjektName = g.First().Projekt!.Projektbeschreibung,
                Durchschnitt = g.Average(a => a.Rating)
            })
            .OrderBy(p => p.ProjektId)
            .ToList();
    }

    private async Task OnProjectChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
            selectedProjectId = id;
        else
            selectedProjectId = null;

        await LadeProjektDetails();
    }

    private async Task LadeProjektDetails()
    {
        if (selectedProjectId == null)
        {
            aktuellesProjekt = null;
            antwortenProjekt.Clear();
            ratingItemsProjekt.Clear();
            kategorieAuswertungenProjekt.Clear();
            return;
        }

        aktuellesProjekt = await _context.Projekte
            .AsNoTracking()
            .FirstOrDefaultAsync(p => p.Id == selectedProjectId.Value);

        antwortenProjekt = alleAntworten
            .Where(a => a.ProjektId == selectedProjectId.Value)
            .ToList();

        BerechneSternverteilungProjekt();
        BerechneKategorieAuswertungProjekt();
    }

    private void BerechneSternverteilungProjekt()
    {
        var counts = new int[5];

        foreach (var a in antwortenProjekt)
        {
            if (a.Rating >= 1 && a.Rating <= 5)
                counts[a.Rating - 1]++;
        }

        ratingItemsProjekt = new()
        {
            new RatingItem { Category = "1 Stern", Value = counts[0] },
            new RatingItem { Category = "2 Sterne", Value = counts[1] },
            new RatingItem { Category = "3 Sterne", Value = counts[2] },
            new RatingItem { Category = "4 Sterne", Value = counts[3] },
            new RatingItem { Category = "5 Sterne", Value = counts[4] }
        };
    }

    private void BerechneKategorieAuswertungProjekt()
    {
        kategorieAuswertungenProjekt = antwortenProjekt
            .GroupBy(a => a.Frage.KategorieId)
            .Select(g => new KategorieAuswertung
            {
                KategorieName = g.First().Frage.Kategorie.Name,
                Durchschnitt = g.Average(a => a.Rating),
                Anzahl = g.Count()
            })
            .OrderBy(k => k.KategorieName)
            .ToList();
    }

    // 🔹 NEU: Chart.js Rendering

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (projektDurchschnitte.Any())
        {
            await RenderProjektVergleichChart();
        }

        if (selectedProjectId != null && antwortenProjekt.Any())
        {
            await RenderSternChart();
            await RenderKategorieChart();
        }
    }

    private async Task RenderProjektVergleichChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "projektVergleichChart",
            "line",
            new
            {
                labels = projektDurchschnitte.Select(p => p.ProjektName),
                datasets = new[]
                {
                    new {
                        label = "Durchschnitt",
                        data = projektDurchschnitte.Select(p => p.Durchschnitt),                   
                        borderColor = "#74181E",
                        backgroundColor = "rgba(116,24,30,0.25)",
                        borderWidth = 2,
                        tension = 0.3,
                    }
                }
            },
            new
            {
                responsive = true,

            }
        );
    }

    private async Task RenderSternChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "sternChart",
            "bar",
            new
            {
                labels = ratingItemsProjekt.Select(r => r.Category),
                datasets = new[]
                {
                    new {
                        label = "Bewertungen",
                        data = ratingItemsProjekt.Select(r => r.Value),
                        backgroundColor = "#74181E88",
                        borderColor = "#74181E",
                        borderWidth = 2
                    }
                }
            },
            new
            {
                responsive = true
            }
        );
    }

    private async Task RenderKategorieChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "kategorieChart",
            "bar",
            new
            {
                labels = kategorieAuswertungenProjekt.Select(k => k.KategorieName),
                datasets = new[]
                {
                    new {
                        label = "Durchschnitt",
                        data = kategorieAuswertungenProjekt.Select(k => k.Durchschnitt),
                        backgroundColor = "#74181E88",
                        borderColor = "#74181E",
                        borderWidth = 2
                    }
                }
            },
            new
            {
                indexAxis = "y",
                responsive = true
            }
        );
    }
}