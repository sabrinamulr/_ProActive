@page "/kantine/auswertung-koch"

@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja.Kantine
@using Microsoft.EntityFrameworkCore

@inject AppDbContext _context
@inject IJSRuntime JS
@inject PdfAuswertung PdfService

@rendermode InteractiveServer

<div class="container mt-4">
    <h2 class="mb-4">Auswertung Küche</h2>

<button class="btn btn-danger mb-4" @onclick="ExportPdfAsync" disabled="@isLoading">
    PDF exportieren
</button>

    @if (isLoading)
    {
        <div class="alert alert-info">Lade Daten…</div>
    }
    else
    {
        <!-- ⭐ SEKTION 1: PREISE -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Gericht auswählen (Preisentwicklung)</strong>
            </div>
            <div class="card-body">
                <select class="form-select w-auto" @onchange="OnGerichtChanged">
                    <option value="">-- Bitte Gericht wählen --</option>
                    @foreach (var g in gerichte)
                    {
                        <option value="@g.Id">@g.Gerichtname</option>
                    }
                </select>

                @if (selectedGerichtId == null || !preisverlaufSelected.Any())
                {
                    <p>Gericht nicht ausgewählt</p>
                }
                else
                {
                    <canvas id="preisVerlaufChart" height="120"></canvas>
                }
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Preis vs. Nachfrage (alle Gerichte)</strong>
            </div>
            <div class="card-body">
                <canvas id="preisNachfrageChart" height="140"></canvas>
            </div>
        </div>

        <!-- ⭐ SEKTION 2: NACHFRAGE -->
        <h3 class="mt-5 mb-3">Nachfrage</h3>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Beliebteste Gerichte</strong>
            </div>
            <div class="card-body">
                <canvas id="beliebtesteGerichteChart" height="140"></canvas>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Nachfrage pro Woche</strong>
            </div>
            <div class="card-body">
                <canvas id="nachfrageWWocheChart" height="140"></canvas>
            </div>
        </div>

        <!-- ⭐ SEKTION 3: ALLERGENE -->
        <h3 class="mt-5 mb-3">Allergene</h3>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Allergene Verteilung</strong>
            </div>
            <div class="card-body">
                <canvas id="allergeneChart" height="300"></canvas>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;

    private List<Gericht> gerichte = new();
    private List<Preisverlauf> allePreisverlaeufe = new();
    private List<Vorbestellung> vorbestellungen = new();
    private List<Menueplan> menueplaene = new();
    private List<MenueplanTag> menueplanTage = new();
    private List<GerichtAllergen> gerichtAllergene = new();
    private List<Allergen> allergene = new();

    private int? selectedGerichtId = null;
    private string? selectedGerichtName;
    private List<Preisverlauf> preisverlaufSelected = new();

    private List<PreisNachfrageItem> preisNachfrageItems = new();
    private List<BeliebtheitItem> beliebtesteGerichte = new();
    private List<NachfrageWocheItem> nachfrageProWoche = new();

    private List<AllergenVerteilungItem> allergenVerteilung = new();
    private int anzahlAllergenfrei = 0;

    public class PreisNachfrageItem { public string GerichtName { get; set; } = ""; public decimal Preis { get; set; } public int Nachfrage { get; set; } }
    public class BeliebtheitItem { public string GerichtName { get; set; } = ""; public int Anzahl { get; set; } }
    public class NachfrageWocheItem { public int Woche { get; set; } public int Anzahl { get; set; } }
    public class AllergenVerteilungItem { public string Name { get; set; } = ""; public int Anzahl { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        gerichte = await _context.Gerichte.AsNoTracking().ToListAsync();
        allePreisverlaeufe = await _context.Preisverlaeufe.AsNoTracking().ToListAsync();
        vorbestellungen = await _context.Vorbestellungen.AsNoTracking().ToListAsync();
        menueplaene = await _context.Menueplaene.AsNoTracking().ToListAsync();
        menueplanTage = await _context.MenueplanTage.AsNoTracking().ToListAsync();
        gerichtAllergene = await _context.GerichtAllergene.AsNoTracking().ToListAsync();
        allergene = await _context.Allergene.AsNoTracking().ToListAsync();

        await BerechnePreisVsNachfrage();
        await BerechneBeliebtesteGerichte();
        await BerechneNachfrageProWoche();
        await BerechneAllergene();

        isLoading = false;
    }

    private async Task BerechnePreisVsNachfrage()
    {
        var joined = vorbestellungen
            .Join(menueplaene, v => v.EintragId, m => m.Id, (v, m) => new { m.GerichtId })
            .GroupBy(x => x.GerichtId)
            .Select(g => new { GerichtId = g.Key, Nachfrage = g.Count() })
            .ToList();

        var aktuellerPreis = allePreisverlaeufe
            .GroupBy(p => p.GerichtId)
            .Select(g => new { GerichtId = g.Key, Preis = g.OrderByDescending(x => x.GueltigAb).First().Preis })
            .ToList();

        preisNachfrageItems = (
            from g in gerichte
            join p in aktuellerPreis on g.Id equals p.GerichtId
            join n in joined on g.Id equals n.GerichtId into gj
            from n in gj.DefaultIfEmpty()
            select new PreisNachfrageItem
            {
                GerichtName = g.Gerichtname,
                Preis = p.Preis,
                Nachfrage = n?.Nachfrage ?? 0
            }
        ).ToList();
    }

    private async Task BerechneBeliebtesteGerichte()
    {
        beliebtesteGerichte = vorbestellungen
            .Join(menueplaene, v => v.EintragId, m => m.Id, (v, m) => m.GerichtId)
            .GroupBy(id => id)
            .Select(g => new BeliebtheitItem
            {
                GerichtName = gerichte.First(x => x.Id == g.Key).Gerichtname,
                Anzahl = g.Count()
            })
            .OrderByDescending(x => x.Anzahl)
            .ToList();
    }

    private async Task BerechneNachfrageProWoche()
    {
        nachfrageProWoche = vorbestellungen
            .Join(menueplaene, v => v.EintragId, m => m.Id, (v, m) => new { v, m.MenueplanTagId })
            .Join(menueplanTage, x => x.MenueplanTagId, t => t.Id, (x, t) => t.Tag)
            .GroupBy(d => System.Globalization.CultureInfo.CurrentCulture.Calendar
                .GetWeekOfYear(d, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday))
            .Select(g => new NachfrageWocheItem { Woche = g.Key, Anzahl = g.Count() })
            .OrderBy(x => x.Woche)
            .ToList();
    }

    private async Task BerechneAllergene()
    {
        allergenVerteilung = gerichtAllergene
            .GroupBy(a => a.AllergenId)
            .Select(g => new AllergenVerteilungItem
            {
                Name = allergene.First(x => x.Id == g.Key).Kuerzel,
                Anzahl = g.Count()
            })
            .OrderByDescending(x => x.Anzahl)
            .ToList();

        anzahlAllergenfrei = gerichte
            .Count(g => !gerichtAllergene.Any(a => a.GerichtId == g.Id));
    }

    private async Task OnGerichtChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedGerichtId = id;
            selectedGerichtName = gerichte.First(g => g.Id == id).Gerichtname;

            preisverlaufSelected = allePreisverlaeufe
                .Where(p => p.GerichtId == id)
                .OrderBy(p => p.GueltigAb)
                .ToList();
        }
        else
        {
            selectedGerichtId = null;
            preisverlaufSelected.Clear();
        }

        await RenderCharts();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading)
            await RenderCharts();
    }

    private async Task RenderCharts()
    {
        if (selectedGerichtId != null && preisverlaufSelected.Any())
            await RenderPreisVerlaufChart();

        if (preisNachfrageItems.Any())
            await RenderPreisNachfrageChart();

        if (beliebtesteGerichte.Any())
            await RenderBeliebtesteGerichteChart();

        if (nachfrageProWoche.Any())
            await RenderNachfrageWocheChart();

        if (allergenVerteilung.Any())
            await RenderAllergeneChart();
    }

    private async Task RenderPreisVerlaufChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "preisVerlaufChart",
            "line",
            new
            {
                labels = preisverlaufSelected.Select(p => p.GueltigAb.ToString("dd.MM.yyyy")),
                datasets = new[]
                {
                    new {
                        label = $"Preisverlauf – {selectedGerichtName}",
                        data = preisverlaufSelected.Select(p => p.Preis),
                        borderColor = "#74181E",
                        backgroundColor = "rgba(116,24,30,0.25)",
                        borderWidth = 2,
                        tension = 0.3
                    }
                }
            },
            new { responsive = true }
        );
    }

    private async Task RenderPreisNachfrageChart()
    {
        var dataPoints = preisNachfrageItems.Select(i => new { x = i.Preis, y = i.Nachfrage });

        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "preisNachfrageChart",
            "scatter",
            new
            {
                datasets = new[]
                {
                    new {
                        label = "Preis vs. Nachfrage",
                        data = dataPoints,
                        backgroundColor = "rgba(116,24,30,0.6)",
                        borderColor = "#74181E",
                        pointRadius = 5
                    }
                }
            },
            new
            {
                responsive = true,
                scales = new
                {
                    x = new { title = new { display = true, text = "Preis (€)" } },
                    y = new { title = new { display = true, text = "Vorbestellungen" }, beginAtZero = true }
                }
            }
        );
    }

    private async Task RenderBeliebtesteGerichteChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "beliebtesteGerichteChart",
            "bar",
            new
            {
                labels = beliebtesteGerichte.Select(x => x.GerichtName),
                datasets = new[]
                {
                    new {
                        label = "Vorbestellungen",
                        data = beliebtesteGerichte.Select(x => x.Anzahl),
                        backgroundColor = "#74181E88",
                        borderColor = "#74181E",
                        borderWidth = 2
                    }
                }
            },
            new { responsive = true }
        );
    }

    private async Task RenderNachfrageWocheChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "nachfrageWocheChart",
            "line",
            new
            {
                labels = nachfrageProWoche.Select(x => $"KW {x.Woche}"),
                datasets = new[]
                {
                    new {
                        label = "Vorbestellungen pro Woche",
                        data = nachfrageProWoche.Select(x => x.Anzahl),
                        borderColor = "#74181E",
                        backgroundColor = "rgba(116,24,30,0.25)",
                        borderWidth = 2,
                        tension = 0.3
                    }
                }
            },
            new { responsive = true }
        );
    }

    private async Task RenderAllergeneChart()
    {
        await JS.InvokeVoidAsync("chartFunctions.createChart",
            "allergeneChart",
            "pie",
            new
            {
                labels = allergenVerteilung.Select(x => x.Name),
                datasets = new[]
                {
                    new {
                        label = "Allergene",
                        data = allergenVerteilung.Select(x => x.Anzahl),
                        backgroundColor = new[]
                        {
                            "#74181E", "#A63A3A", "#D96C6C", "#F2A2A2",
                            "#C27BA0", "#8E44AD", "#5DADE2", "#48C9B0"
                        }
                    }
                }
            },
            new { responsive = true, maintainAspectRatio = false }
        );
    }

    // ⭐ PDF EXPORT
    private async Task ExportPdfAsync()
    {
        string preisVerlaufImg = await JS.InvokeAsync<string>("chartFunctions.getChartImage", "preisVerlaufChart");
        string preisNachfrageImg = await JS.InvokeAsync<string>("chartFunctions.getChartImage", "preisNachfrageChart");
        string beliebtesteImg = await JS.InvokeAsync<string>("chartFunctions.getChartImage", "beliebtesteGerichteChart");
        string nachfrageWocheImg = await JS.InvokeAsync<string>("chartFunctions.getChartImage", "nachfrageWocheChart");
        string allergeneImg = await JS.InvokeAsync<string>("chartFunctions.getChartImage", "allergeneChart");

        byte[] pdf = PdfService.BuildKochAuswertungPdf(
            preisVerlaufImg,
            preisNachfrageImg,
            beliebtesteImg,
            nachfrageWocheImg,
            allergeneImg,
            preisNachfrageItems,
            beliebtesteGerichte,
            nachfrageProWoche,
            allergenVerteilung
        );


        string base64 = Convert.ToBase64String(pdf);
        await JS.InvokeVoidAsync("downloadFileFromBytes", "KochAuswertung.pdf", base64);
    }
}