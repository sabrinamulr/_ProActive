@page "/kantine/auswertung-koch"

@using ProActive2508.Data
@using ProActive2508.Models.Entity.Anja.Kantine
@using Microsoft.EntityFrameworkCore

@inject AppDbContext _context
@inject IJSRuntime JS

@rendermode InteractiveServer

<div class="container mt-4">
    <h2 class="mb-4">Auswertung Küche</h2>

    @if (isLoading)
    {
        <div class="alert alert-info">Lade Daten…</div>
    }
    else
    {
        <!-- ⭐ SEKTION 1: PREISE -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Gericht auswählen (Preisentwicklung)</strong>
            </div>
            <div class="card-body">
                <select class="form-select w-auto" @onchange="OnGerichtChanged">
                    <option value="">-- Bitte Gericht wählen --</option>
                    @foreach (Gericht g in gerichte)
                    {
                        <option value="@g.Id">@g.Gerichtname</option>
                    }
                </select>

                @if (selectedGerichtId == null || !preisverlaufSelected.Any())
                {
                    <p>Gericht nicht ausgewählt</p>
                }
                else
                {
                    <canvas id="preisVerlaufChart" height="120"></canvas>
                }
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Preis vs. Nachfrage (alle Gerichte)</strong>
            </div>
            <div class="card-body">
                <canvas id="preisNachfrageChart" height="140"></canvas>
            </div>
        </div>

        <!-- ⭐ SEKTION 2: NACHFRAGE -->
        <h3 class="mt-5 mb-3">Nachfrage</h3>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Beliebteste Gerichte</strong>
            </div>
            <div class="card-body">
                <canvas id="beliebtesteGerichteChart" height="140"></canvas>
            </div>
        </div>

        <!-- ⭐ SEKTION 3: ALLERGENE -->
        <h3 class="mt-5 mb-3">Allergene</h3>

        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <strong>Allergene Verteilung</strong>
            </div>
            <div class="card-body">
                <canvas id="allergeneChart" height="300"></canvas>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;

    private List<Gericht> gerichte = new();
    private List<Preisverlauf> allePreisverlaeufe = new();
    private List<Vorbestellung> vorbestellungen = new();
    private List<Menueplan> menueplaene = new();
    private List<MenueplanTag> menueplanTage = new();
    private List<GerichtAllergen> gerichtAllergene = new();
    private List<Allergen> allergene = new();

    private int? selectedGerichtId = null;
    private string? selectedGerichtName;
    private List<Preisverlauf> preisverlaufSelected = new();

    private List<PreisNachfrageItem> preisNachfrageItems = new();
    private List<BeliebtheitItem> beliebtesteGerichte = new();
    private List<NachfrageWocheItem> nachfrageProWoche = new();

    private List<AllergenVerteilungItem> allergenVerteilung = new();
    private int anzahlAllergenfrei = 0;

    public class PreisNachfrageItem { public string GerichtName { get; set; } = ""; public decimal Preis { get; set; } public int Nachfrage { get; set; } }
    public class BeliebtheitItem { public string GerichtName { get; set; } = ""; public int Anzahl { get; set; } }
    public class NachfrageWocheItem { public int Woche { get; set; } public int Anzahl { get; set; } }
    public class AllergenVerteilungItem { public string Name { get; set; } = ""; public int Anzahl { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        gerichte = await _context.Gerichte.AsNoTracking().ToListAsync();
        allePreisverlaeufe = await _context.Preisverlaeufe.AsNoTracking().ToListAsync();
        vorbestellungen = await _context.Vorbestellungen.AsNoTracking().ToListAsync();
        menueplaene = await _context.Menueplaene.AsNoTracking().ToListAsync();
        menueplanTage = await _context.MenueplanTage.AsNoTracking().ToListAsync();
        gerichtAllergene = await _context.GerichtAllergene.AsNoTracking().ToListAsync();
        allergene = await _context.Allergene.AsNoTracking().ToListAsync();

        await BerechnePreisVsNachfrage();
        await BerechneBeliebtesteGerichte();
        await BerechneAllergene();

        isLoading = false;
    }

private async Task BerechnePreisVsNachfrage()
{
    // 1. JOIN: Vorbestellungen + Menüpläne
    List<int> joinedGerichte = new List<int>(); 
    // Liste aller Gericht-IDs, die vorbestellt wurden

    foreach (Vorbestellung v in vorbestellungen)
    {
        foreach (Menueplan m in menueplaene)
        {
            if (v.EintragId == m.Id) // Join-Bedingung
            {
                joinedGerichte.Add(m.GerichtId);
            }
        }
    }

    // 2. Gruppieren nach GerichtId
    Dictionary<int, int> nachfrageProGericht = new Dictionary<int, int>();

    foreach (int gerichtId in joinedGerichte)
    {
        if (!nachfrageProGericht.ContainsKey(gerichtId))
        {
            nachfrageProGericht[gerichtId] = 0;
        }

        nachfrageProGericht[gerichtId]++; // Nachfrage erhöhen
    }

    // 3. Aktuellen Preis pro Gericht bestimmen
    Dictionary<int, decimal> aktuellerPreis = new Dictionary<int, decimal>();

    foreach (Preisverlauf preis in allePreisverlaeufe)
    {
        int gerichtId = preis.GerichtId;

        // Wenn Gericht noch nicht drin ist --> hinzufügen
        if (!aktuellerPreis.ContainsKey(gerichtId))
        {
            aktuellerPreis[gerichtId] = preis.Preis;
        }
        else
        {
            // neueren Preis finden (GueltigAb vergleichen)
            Preisverlauf neuester = null;

            foreach (Preisverlauf p in allePreisverlaeufe)
            {
                if (p.GerichtId == gerichtId)
                {
                    if (neuester == null || p.GueltigAb > neuester.GueltigAb)
                    {
                        neuester = p;
                    }
                }
            }

            aktuellerPreis[gerichtId] = neuester.Preis;
        }
    }

    // 4. Ergebnisliste zusammenbauen
    preisNachfrageItems = new List<PreisNachfrageItem>();

    foreach (Gericht g in gerichte)
    {
        PreisNachfrageItem item = new PreisNachfrageItem();
        item.GerichtName = g.Gerichtname;

        // Preis holen
        if (aktuellerPreis.ContainsKey(g.Id))
        {
            item.Preis = aktuellerPreis[g.Id];
        }

        // Nachfrage holen
        if (nachfrageProGericht.ContainsKey(g.Id))
        {
            item.Nachfrage = nachfrageProGericht[g.Id];
        }
        else
        {
            item.Nachfrage = 0;
        }

        preisNachfrageItems.Add(item);
    }
}

private async Task BerechneBeliebtesteGerichte()
{
    // 1. JOIN: Vorbestellungen + Menüpläne
    List<int> gerichtIds = new List<int>();

    foreach (Vorbestellung v in vorbestellungen)
    {
        foreach (Menueplan m in menueplaene)
        {
            if (v.EintragId == m.Id)
            {
                gerichtIds.Add(m.GerichtId);
            }
        }
    }

    // 2. Gruppieren nach GerichtId
    Dictionary<int, int> anzahlProGericht = new Dictionary<int, int>();

    foreach (int id in gerichtIds)
    {
        if (!anzahlProGericht.ContainsKey(id))
        {
            anzahlProGericht[id] = 0;
        }

        anzahlProGericht[id]++;
    }

    // 3. Ergebnisliste erstellen
    List<BeliebtheitItem> liste = new List<BeliebtheitItem>();

    foreach (var eintrag in anzahlProGericht)
    {
        int gerichtId = eintrag.Key;
        int anzahl = eintrag.Value;

        Gericht gericht = null;

        foreach (Gericht g in gerichte)
        {
            if (g.Id == gerichtId)
            {
                gericht = g;
                break;
            }
        }

        BeliebtheitItem item = new BeliebtheitItem();
        item.GerichtName = gericht.Gerichtname;
        item.Anzahl = anzahl;

        liste.Add(item);
    }

    // 4. Sortieren nach Anzahl (DESC)
    liste.Sort((BeliebtheitItem x, BeliebtheitItem y) => y.Anzahl.CompareTo(x.Anzahl));

    beliebtesteGerichte = liste;
}

private async Task BerechneAllergene()
{
    // 1. Gruppieren nach AllergenId
    Dictionary<int, int> allergenZaehler = new Dictionary<int, int>();

    foreach (GerichtAllergen ga in gerichtAllergene)
    {
        int allergenId = ga.AllergenId;

        if (!allergenZaehler.ContainsKey(allergenId))
        {
            allergenZaehler[allergenId] = 0;
        }

        allergenZaehler[allergenId]++;
    }

    // 2. Ergebnisliste erstellen
    List<AllergenVerteilungItem> liste = new List<AllergenVerteilungItem>();

    foreach (var eintrag in allergenZaehler)
    {
        int allergenId = eintrag.Key;
        int anzahl = eintrag.Value;

        Allergen allergen = null;

        foreach (Allergen a in allergene)
        {
            if (a.Id == allergenId)
            {
                allergen = a;
                break;
            }
        }

        AllergenVerteilungItem item = new AllergenVerteilungItem();
        item.Name = allergen.Kuerzel;
        item.Anzahl = anzahl;

        liste.Add(item);
    }

    // 3. Sortieren nach Anzahl (DESC)
    liste.Sort((AllergenVerteilungItem x, AllergenVerteilungItem y) => y.Anzahl.CompareTo(x.Anzahl));

    allergenVerteilung = liste;

    // 4. Anzahl allergenfreier Gerichte
    int count = 0;

    foreach (Gericht g in gerichte)
    {
        bool hatAllergen = false;

        foreach (GerichtAllergen ga in gerichtAllergene)
        {
            if (ga.GerichtId == g.Id)
            {
                hatAllergen = true;
                break;
            }
        }

        if (!hatAllergen)
        {
            count++;
        }
    }

    anzahlAllergenfrei = count;
}

    private async Task OnGerichtChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedGerichtId = id;
            selectedGerichtName = gerichte.First(g => g.Id == id).Gerichtname;

            preisverlaufSelected = allePreisverlaeufe
                .Where(p => p.GerichtId == id)
                .OrderBy(p => p.GueltigAb)
                .ToList();
        }
        else
        {
            selectedGerichtId = null;
            preisverlaufSelected.Clear();
        }

        await RenderCharts();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading)
            await RenderCharts();
    }

    private async Task RenderCharts()
    {
        if (selectedGerichtId != null && preisverlaufSelected.Any())
            await RenderPreisVerlaufChart();

        if (preisNachfrageItems.Any())
            await RenderPreisNachfrageChart();

        if (beliebtesteGerichte.Any())
            await RenderBeliebtesteGerichteChart();


        if (allergenVerteilung.Any())
            await RenderAllergeneChart();
    }

    private async Task RenderPreisVerlaufChart()
    {
        await JS.InvokeVoidAsync("createChart",
            "preisVerlaufChart",
            "line",
            new
            {
                labels = preisverlaufSelected.Select(p => p.GueltigAb.ToString("dd.MM.yyyy")),
                datasets = new[]
                {
                    new {
                        label = $"Preisverlauf – {selectedGerichtName}",
                        data = preisverlaufSelected.Select(p => p.Preis),
                        borderColor = "#74181E",
                        backgroundColor = "rgba(116,24,30,0.25)",
                        borderWidth = 2,
                        tension = 0.3
                    }
                }
            },
            new { responsive = true }
        );
    }

    private async Task RenderPreisNachfrageChart()
    {
        var dataPoints = preisNachfrageItems.Select(i => new { x = i.Preis, y = i.Nachfrage });

        await JS.InvokeVoidAsync("createChart",
            "preisNachfrageChart",
            "scatter",
            new
            {
                datasets = new[]
                {
                    new {
                        label = "Preis vs. Nachfrage",
                        data = dataPoints,
                        backgroundColor = "rgba(116,24,30,0.6)",
                        borderColor = "#74181E",
                        pointRadius = 5
                    }
                }
            },
            new
            {
                responsive = true,
                scales = new
                {
                    x = new { title = new { display = true, text = "Preis (€)" } },
                    y = new { title = new { display = true, text = "Vorbestellungen" }, beginAtZero = true }
                }
            }
        );
    }

    private async Task RenderBeliebtesteGerichteChart()
    {
        await JS.InvokeVoidAsync("createChart",
            "beliebtesteGerichteChart",
            "bar",
            new
            {
                labels = beliebtesteGerichte.Select(x => x.GerichtName),
                datasets = new[]
                {
                    new {
                        label = "Vorbestellungen",
                        data = beliebtesteGerichte.Select(x => x.Anzahl),
                        backgroundColor = "#74181E88",
                        borderColor = "#74181E",
                        borderWidth = 2
                    }
                }
            },
            new { responsive = true }
        );
    }

   

    private async Task RenderAllergeneChart()
    {
        await JS.InvokeVoidAsync("createChart",
            "allergeneChart",
            "pie",
            new
            {
                labels = allergenVerteilung.Select(x => x.Name),
                datasets = new[]
                {
                    new {
                        label = "Allergene",
                        data = allergenVerteilung.Select(x => x.Anzahl),
                        backgroundColor = new[]
                        {
                            "#74181E", "#A63A3A", "#D96C6C", "#F2A2A2",
                            "#C27BA0", "#8E44AD", "#5DADE2", "#48C9B0"
                        }
                    }
                }
            },
            new { responsive = true, maintainAspectRatio = false }
        );
    }

}