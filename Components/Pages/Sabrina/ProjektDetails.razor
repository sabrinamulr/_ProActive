@page "/projekt/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using ProActive2508.Models.Entity.Anja
@attribute [Authorize]
@rendermode InteractiveServer

@if (isLoading)
{
    <p>Lade…</p>
}
else if (project is null)
{
    <div class="alert alert-warning">Projekt nicht gefunden.</div>
}
else
{
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">@($"Projekt #{project.Id}")</h4>
            <p class="card-text">@project.Projektbeschreibung</p>

            <dl class="row">
                <dt class="col-sm-3">Projektleiter</dt>
                <dd class="col-sm-9">@(_userLookup.TryGetValue(project.ProjektleiterId, out var pl) ? pl : $"Id:{project.ProjektleiterId}")</dd>

                <dt class="col-sm-3">Auftraggeber</dt>
                <dd class="col-sm-9">@(_userLookup.TryGetValue(project.AuftraggeberId, out var ag) ? ag : $"Id:{project.AuftraggeberId}")</dd>

                <dt class="col-sm-3">Status</dt>
                <dd class="col-sm-9">@project.Status</dd>

                <dt class="col-sm-3">Phase</dt>
                <dd class="col-sm-9">@project.Phase</dd>
            </dl>

            @if (CanEdit)
            {
                <button class="btn btn-outline-secondary" @onclick="EnableEdit">Bearbeiten</button>
            }
        </div>
    </div>

    @* PHASEN: komplette Liste für Projektleiter, sonst aktuelle Phase + Timeline *@
    <div class="mt-3">
        @if (isProjektleiterRole)
        {
            @if (projectPhases == null || !projectPhases.Any())
            {
                <div class="alert alert-info">Keine Phasen hinterlegt.</div>
            }
            else
            {
                <div class="d-flex gap-2 flex-wrap">
                    @foreach (var pp in projectPhases)
                    {
                        <div class="badge bg-light text-dark border">
                            <div class="fw-semibold">@pp.Phase?.Kurzbezeichnung</div>
                            <div class="small text-muted">@($"{pp.StartDate:dd.MM.yyyy} → {pp.DueDate:dd.MM.yyyy}")</div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            @if (currentPhase == null)
            {
                <div class="text-muted small">Keine aktive Phase.</div>
            }
            else
            {
                <div class="mb-2">
                    <div class="fw-semibold">@currentPhase.Phase?.Bezeichnung</div>
                    <div class="small text-muted">@($"{currentPhase.StartDate:dd.MM.yyyy} – {currentPhase.DueDate:dd.MM.yyyy}")</div>
                </div>

                <div class="timeline d-flex" style="gap:6px;">
                    @if (projectPhases == null || !projectPhases.Any())
                    {
                        <div class="text-muted small">Phasen fehlen.</div>
                    }
                    else
                    {
                        var segWidth = Math.Max(8, 100 / projectPhases.Count);
                        foreach (var seg in projectPhases)
                        {
                            var isCurrent = currentPhase != null && seg.Id == currentPhase.Id;
                            var segStyle = $"flex:0 0 {segWidth}%; height:12px; border-radius:4px; background:{(isCurrent ? "#0d6efd" : "#e9ecef")};";
                            var segTitle = $"{seg.Phase?.Kurzbezeichnung} {seg.StartDate:dd.MM}→{seg.DueDate:dd.MM}";
                            <div style="@segStyle" title="@segTitle"></div>
                        }
                    }
                </div>
            }
        }
    </div>
}

<style>
    .timeline { align-items:center; margin-top:6px; }
</style>