@page "/ProjekteNeu"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using ProActive2508.Models.Entity.Anja
@attribute [Authorize(Roles = "Projektleiter")]
@rendermode InteractiveServer

<h3>Neues Projekt</h3>

@if (!string.IsNullOrWhiteSpace(uiError))
{
    <div class="alert alert-warning d-flex justify-content-between align-items-start" role="alert">
        <div><strong>Fehler:</strong> @uiError</div>
        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => uiError = null">OK</button>
    </div>
}

@if (isSaving)
{
    <p>Speichere…</p>
}
else
{
    <EditForm Model="model" OnValidSubmit="SaveAsync" FormName="ProjektNeuForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Name</label>
            <InputText class="form-control" @bind-Value="model.Name" />
        </div>

        <div class="mb-3">
            <label class="form-label">Beschreibung</label>
            <InputTextArea class="form-control" @bind-Value="model.Description" rows="4" />
        </div>

        <div class="mb-3">
            <label class="form-label">Fertigstellungsdatum</label>
            <InputDate class="form-control" @bind-Value="model.ExpectedCompletionDate" />
        </div>

        <hr />
        <h6>Mitglieder</h6>

        <div class="mb-3">
            <label class="form-label">Auswählen </label>
            <div class="border rounded p-2" style="max-height:220px; overflow:auto;">
                @if (allUsers != null && allUsers.Any())
                {
                    @foreach (Benutzer u in allUsers)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="mem_@u.Id" checked="@selectedMemberIds.Contains(u.Id)" @onchange="@( (ChangeEventArgs e) => ToggleMember(u.Id, (e?.Value as bool?) == true) )" />
                            <label class="form-check-label" for="mem_@u.Id">@u.Email</label>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted">Keine Benutzer vorhanden.</div>
                }
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Aktuelle Mitglieder</label>
            <div>
                @if (selectedMemberIds == null || !selectedMemberIds.Any())
                {
                    <div class="text-muted">Keine Mitglieder ausgewählt.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (int uid in selectedMemberIds)
                        {
                            Benutzer usr = allUsers.FirstOrDefault(x => x.Id == uid);
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>@(usr?.Email ?? $"Id:{uid}")</div>
                                <button class="btn btn-sm btn-outline-danger" type="button" @onclick="@(() => RemoveMember(uid))">Entfernen</button>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" disabled="@isSaving" @onclick="SaveAndDefineAsync">Weiter</button>

            <button type="submit" class="btn btn-primary" disabled="@isSaving">Speichern</button>

            <button type="button" class="btn btn-secondary" @onclick="Cancel">Abbrechen</button>
        </div>
    </EditForm>
}