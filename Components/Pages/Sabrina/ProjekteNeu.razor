@page "/ProjekteNeu"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using ProActive2508.Models.Entity.Anja
@attribute [Authorize(Roles = "Projektleiter")]
@rendermode InteractiveServer

<h3>Neues Projekt</h3>

@if (!string.IsNullOrWhiteSpace(uiError))
{
    <div class="alert alert-warning d-flex justify-content-between align-items-start" role="alert">
        <div><strong>Fehler:</strong> @uiError</div>
        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="() => uiError = null">OK</button>
    </div>
}

@if (isSaving)
{
    <p>Speichere…</p>
}
else
{
    <EditForm Model="model" OnValidSubmit="SaveAsync" FormName="ProjektNeuForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Name</label>
            <InputText class="form-control" @bind-Value="model.Name" />
        </div>

        <div class="mb-3">
            <label class="form-label">Beschreibung</label>
            <InputTextArea class="form-control" @bind-Value="model.Description" rows="4" />
        </div>

        <div class="mb-3">
            <label class="form-label">Fertigstellungsdatum</label>
            <InputDate class="form-control" @bind-Value="model.ExpectedCompletionDate" />
        </div>

        <hr />
        <h6>Mitglieder</h6>

        <div class="mb-3">
            <label class="form-label">Auswählen </label>
            <div class="border rounded p-2" style="max-height:220px; overflow:auto;">
                @if (allUsers != null && allUsers.Any())
                {
                    @foreach (var u in allUsers)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="mem_@u.Id" checked="@selectedMemberIds.Contains(u.Id)" @onchange="@((ChangeEventArgs e) => ToggleMember(u.Id, (e?.Value as bool?) == true))" />
                            <label class="form-check-label" for="mem_@u.Id">@u.Email</label>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted">Keine Benutzer vorhanden.</div>
                }
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Aktuelle Mitglieder</label>
            <div>
                @if (selectedMemberIds == null || !selectedMemberIds.Any())
                {
                    <div class="text-muted">Keine Mitglieder ausgewählt.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (var uid in selectedMemberIds)
                        {
                            var usr = allUsers.FirstOrDefault(x => x.Id == uid);
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>@(usr?.Email ?? $"Id:{uid}")</div>
                                <button class="btn btn-sm btn-outline-danger" type="button" @onclick="@(() => RemoveMember(uid))">Entfernen</button>
                            </li>
                        }
                    </ul>
                }
            </div>
        </div>

        @*Phasen*@
        @* 
        @if (editPhaseSelections != null && editPhaseSelections.Any())
        {
            <hr />
            <h6>Phasen</h6>
            @foreach (var sel in editPhaseSelections)
            {
                <div class="mb-2">
                    <div class="fw-semibold">@sel.PhaseKurz</div>
                    <div class="row g-2 mt-1">
                        <div class="col-md-3">
                            <label class="form-label">Start</label>
                            <InputDate class="form-control" @bind-Value="sel.StartDate" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Due</label>
                            <InputDate class="form-control" @bind-Value="sel.DueDate" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <InputSelect class="form-select" @bind-Value="sel.Status">
                                <option value="">— wählen —</option>
                                <option value="Grün">Grün</option>
                                <option value="Gelb">Gelb</option>
                                <option value="Rot">Rot</option>
                                <option value="Geplant">Geplant</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Verantwortlicher</label>
                            <InputSelect class="form-select" @bind-Value="sel.VerantwortlicherBenutzerId">
                                <option value="0">-- auswählen --</option>
                                @foreach (var u in allUsers)
                                {
                                    <option value="@u.Id">@u.Email</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                </div>
            }
        }*@

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" disabled="@isSaving" @onclick="SaveAndDefineAsync">Weiter</button>

            <button type="submit" class="btn btn-primary" disabled="@isSaving">Speichern</button>

            <button type="button" class="btn btn-secondary" @onclick="Cancel">Abbrechen</button>
        </div>
    </EditForm>
}